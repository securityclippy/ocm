# Docker Compose for running OpenClaw + OCM together
#
# Usage:
#   1. Build OpenClaw image first (in openclaw repo):
#      docker build -t openclaw:local .
#
#   2. Run both services:
#      docker compose -f docker-compose.openclaw.yml up -d
#
# Required env vars (auto-generated by ./scripts/setup.sh):
#   OPENCLAW_GATEWAY_TOKEN - Gateway auth token
#   OCM_MASTER_KEY - 64 hex chars for credential encryption
#
# Required paths:
#   OPENCLAW_CONFIG_DIR - Host path to ~/.openclaw (or Docker volume)
#   OPENCLAW_WORKSPACE_DIR - Host path to workspace (or Docker volume)
#
# Optional:
#   OPENCLAW_IMAGE - Defaults to openclaw:local

services:
  # ============================================
  # OpenClaw Gateway
  # ============================================
  openclaw:
    image: ${OPENCLAW_IMAGE:-openclaw:local}
    container_name: openclaw
    environment:
      HOME: /home/node
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
      # OCM integration - agent API endpoint
      OCM_AGENT_URL: http://ocm:9999
    volumes:
      - ${OPENCLAW_CONFIG_DIR:-openclaw-config}:/home/node/.openclaw
      - ${OPENCLAW_WORKSPACE_DIR:-openclaw-workspace}:/home/node/.openclaw/workspace
      # Mount config with Control UI CORS settings for LAN binding
      - ./openclaw.docker.json5:/home/node/.openclaw/openclaw.json:ro
    ports:
      - "${OPENCLAW_GATEWAY_PORT:-18789}:18789"
    networks:
      - ocm-network
    depends_on:
      - ocm
    init: true
    restart: unless-stopped
    command:
      [
        "node",
        "dist/index.js",
        "gateway",
        "--bind",
        "lan",
        "--port",
        "18789",
        "--allow-unconfigured",
      ]

  # ============================================
  # OCM - Credential Manager
  # ============================================
  ocm:
    build:
      context: .
      dockerfile: Dockerfile
    image: ocm:local
    container_name: ocm
    environment:
      OCM_MASTER_KEY: ${OCM_MASTER_KEY}
      # Gateway URL for restart triggers
      OCM_GATEWAY_URL: http://openclaw:18789
      # Path to .env file for credential injection
      OCM_ENV_FILE: /openclaw-config/.env
    volumes:
      - ocm-data:/data
      # Share OpenClaw config for .env injection
      - ${OPENCLAW_CONFIG_DIR:-openclaw-config}:/openclaw-config
    ports:
      # Admin UI - expose to host for management
      - "${OCM_ADMIN_PORT:-8080}:8080"
      # Agent API - internal only (OpenClaw connects via docker network)
      # - "9999:9999"
    networks:
      - ocm-network
    restart: unless-stopped
    command:
      [
        "serve",
        "--db", "/data/ocm.db",
        "--agent-addr", ":9999",
        "--admin-addr", ":8080",
        "--gateway-url", "http://openclaw:18789",
        "--env-file", "/openclaw-config/.env"
      ]

networks:
  ocm-network:
    driver: bridge

volumes:
  ocm-data:
  openclaw-config:
  openclaw-workspace:
